# Production Configuration Override
# This file overrides settings from config.yaml when APP_ENV=production or APP_ENV=prod

server:
  port: "${SERVER_PORT:8085}"
  host: "${SERVER_HOST:0.0.0.0}"
  read_timeout: "${SERVER_READ_TIMEOUT:30s}"
  write_timeout: "${SERVER_WRITE_TIMEOUT:30s}"
  idle_timeout: "${SERVER_IDLE_TIMEOUT:120s}"

database:
  type: "${DATABASE_TYPE:postgres}"
  host: "${DATABASE_HOST:localhost}"
  port: ${DATABASE_PORT:5432}
  username: "${DATABASE_USERNAME:postgres}"
  password: "${DATABASE_PASSWORD}"
  database: "${DATABASE_NAME:auth_service}"
  ssl_mode: "${DATABASE_SSL_MODE:require}"  # Require SSL in production

  # Enhanced connection pooling for production
  max_connections: ${DATABASE_MAX_CONNECTIONS:100}
  max_idle_connections: ${DATABASE_MAX_IDLE_CONNECTIONS:25}
  connection_max_lifetime: "${DATABASE_CONNECTION_MAX_LIFETIME:1h}"
  connection_max_idle_time: "${DATABASE_CONNECTION_MAX_IDLE_TIME:30m}"

  # Query optimization settings
  query_timeout: "${DATABASE_QUERY_TIMEOUT:30s}"
  slow_query_threshold: "${DATABASE_SLOW_QUERY_THRESHOLD:1s}"

  # Connection pool settings for high concurrency
  acquire_timeout: "${DATABASE_ACQUIRE_TIMEOUT:30s}"
  acquire_retry_attempts: ${DATABASE_ACQUIRE_RETRY_ATTEMPTS:3}

  # Prepared statement cache
  prepared_statement_cache_size: ${DATABASE_PREPARED_STATEMENT_CACHE_SIZE:100}

  # Logging settings
  log_level: "${DATABASE_LOG_LEVEL:warn}"

cache:
  name: "${CACHE_NAME:auth-cache-prod}"
  addr: "${CACHE_ADDR:localhost:6379}"
  password: "${CACHE_PASSWORD}"
  db: ${CACHE_DB:0}

  # Enhanced connection pooling
  pool_size: ${CACHE_POOL_SIZE:50}
  min_idle_conns: ${CACHE_MIN_IDLE_CONNS:20}
  max_retries: ${CACHE_MAX_RETRIES:5}
  dial_timeout: "${CACHE_DIAL_TIMEOUT:10s}"
  read_timeout: "${CACHE_READ_TIMEOUT:5s}"
  write_timeout: "${CACHE_WRITE_TIMEOUT:5s}"
  pool_timeout: "${CACHE_POOL_TIMEOUT:30s}"
  idle_timeout: "${CACHE_IDLE_TIMEOUT:5m}"
  idle_check_frequency: "${CACHE_IDLE_CHECK_FREQUENCY:1m}"

  # Cluster settings
  use_cluster: ${CACHE_USE_CLUSTER:true}
  cluster_addrs: ${CACHE_CLUSTER_ADDRS:[]}
  cluster_max_redirects: ${CACHE_CLUSTER_MAX_REDIRECTS:3}

  # Pipeline and performance settings
  pipeline_window: "${CACHE_PIPELINE_WINDOW:50ms}"
  pipeline_limit: ${CACHE_PIPELINE_LIMIT:100}
  pipeline_concurrency: ${CACHE_PIPELINE_CONCURRENCY:10}

jwt:
  secret: "${JWT_SECRET}"  # MUST be set via environment variable
  expiration: "${JWT_EXPIRATION:1h}"  # Shorter expiration in production
  refresh_expiration: "${JWT_REFRESH_EXPIRATION:168h}"
  issuer: "${JWT_ISSUER:auth-service}"
  audience: "${JWT_AUDIENCE:auth-service-api}"
  algorithm: "${JWT_ALGORITHM:HS256}"
  bcrypt_cost: ${JWT_BCRYPT_COST:12}

mfa:
  required_factors: ${MFA_REQUIRED_FACTORS:["totp"]}
  optional_factors: ${MFA_OPTIONAL_FACTORS:["sms", "email", "push"]}
  risk_based_mfa: ${MFA_RISK_BASED:true}
  mfa_threshold: ${MFA_THRESHOLD:0.7}
  factor_timeout: "${MFA_FACTOR_TIMEOUT:5m}"
  max_attempts: ${MFA_MAX_ATTEMPTS:3}
  backup_codes: ${MFA_BACKUP_CODES:true}
  backup_code_count: ${MFA_BACKUP_CODE_COUNT:10}

sso:
  token_validation_interval: "${SSO_TOKEN_VALIDATION_INTERVAL:5m}"
  session_timeout: "${SSO_SESSION_TIMEOUT:8h}"
  refresh_threshold: "${SSO_REFRESH_THRESHOLD:1h}"
  max_concurrent_sessions: ${SSO_MAX_CONCURRENT_SESSIONS:3}

session:
  default_timeout: "${SESSION_DEFAULT_TIMEOUT:8h}"
  idle_timeout: "${SESSION_IDLE_TIMEOUT:2h}"
  max_sessions: ${SESSION_MAX_SESSIONS:3}
  refresh_threshold: "${SESSION_REFRESH_THRESHOLD:1h}"
  cleanup_interval: "${SESSION_CLEANUP_INTERVAL:15m}"
  secure_cookies: ${SESSION_SECURE_COOKIES:true}
  http_only_cookies: ${SESSION_HTTP_ONLY_COOKIES:true}
  same_site_policy: "${SESSION_SAME_SITE_POLICY:Strict}"

totp:
  issuer: "${TOTP_ISSUER:AuthService}"
  secret_length: ${TOTP_SECRET_LENGTH:20}
  window_size: ${TOTP_WINDOW_SIZE:1}

sms:
  provider: "${SMS_PROVIDER:twilio}"
  api_key: "${SMS_API_KEY}"
  api_secret: "${SMS_API_SECRET}"
  from_number: "${SMS_FROM_NUMBER}"

email:
  provider: "${EMAIL_PROVIDER:sendgrid}"
  api_key: "${EMAIL_API_KEY}"
  from_email: "${EMAIL_FROM_EMAIL:noreply@yourcompany.com}"

push:
  provider: "${PUSH_PROVIDER:fcm}"
  api_key: "${PUSH_API_KEY}"

risk:
  base_risk_score: ${RISK_BASE_RISK_SCORE:0.1}
  risk_factors:
    new_device: ${RISK_NEW_DEVICE:0.3}
    suspicious_device: ${RISK_SUSPICIOUS_DEVICE:0.4}
    new_location: ${RISK_NEW_LOCATION:0.3}
    suspicious_location: ${RISK_SUSPICIOUS_LOCATION:0.5}
    high_risk_country: ${RISK_HIGH_RISK_COUNTRY:0.4}
    vpn: ${RISK_VPN:0.2}
    tor: ${RISK_TOR:0.6}
    unusual_time: ${RISK_UNUSUAL_TIME:0.3}
    recent_failures: ${RISK_RECENT_FAILURES:0.4}
    new_account: ${RISK_NEW_ACCOUNT:0.2}
    unusual_behavior: ${RISK_UNUSUAL_BEHAVIOR:0.3}
  mfa_threshold: ${RISK_MFA_THRESHOLD:0.6}
  block_threshold: ${RISK_BLOCK_THRESHOLD:0.8}
  trusted_devices: ${RISK_TRUSTED_DEVICES:true}
  geo_fencing: ${RISK_GEO_FENCING:true}
  time_based_rules: ${RISK_TIME_BASED_RULES:true}

audit:
  retention_days: ${AUDIT_RETENTION_DAYS:2555}  # ~7 years for compliance
  real_time_alerts: ${AUDIT_REAL_TIME_ALERTS:true}

logging:
  level: "${LOG_LEVEL:info}"
  format: "${LOG_FORMAT:json}"
  output: "${LOG_OUTPUT:stdout}"
  file:
    enabled: ${LOG_FILE_ENABLED:true}
    path: "${LOG_FILE_PATH:/var/log/auth-service/auth-service.log}"
    max_size: ${LOG_FILE_MAX_SIZE:100}
    max_backups: ${LOG_FILE_MAX_BACKUPS:10}
    max_age: ${LOG_FILE_MAX_AGE:90}
    compress: ${LOG_FILE_COMPRESS:true}

kafka:
  brokers: ${KAFKA_BROKERS:["localhost:9092"]}
  group_id: "${KAFKA_GROUP_ID:auth-service-prod}"
  topics:
    user_events: "${KAFKA_TOPIC_USER_EVENTS:user.events}"
    auth_events: "${KAFKA_TOPIC_AUTH_EVENTS:auth.events}"
    audit_logs: "${KAFKA_TOPIC_AUDIT_LOGS:audit.logs}"
  retry_count: ${KAFKA_RETRY_COUNT:3}
  retry_backoff: "${KAFKA_RETRY_BACKOFF:1s}"

security:
  # Enhanced password policy
  password_min_length: ${SECURITY_PASSWORD_MIN_LENGTH:12}  # Stronger passwords in production
  password_max_length: ${SECURITY_PASSWORD_MAX_LENGTH:128}
  max_login_attempts: ${SECURITY_MAX_LOGIN_ATTEMPTS:3}  # Stricter in production
  lockout_duration: "${SECURITY_LOCKOUT_DURATION:30m}"
  require_email_verification: ${SECURITY_REQUIRE_EMAIL_VERIFICATION:true}

  # Account security
  session_timeout: "${SECURITY_SESSION_TIMEOUT:8h}"
  max_concurrent_sessions: ${SECURITY_MAX_CONCURRENT_SESSIONS:3}
  require_mfa: ${SECURITY_REQUIRE_MFA:true}
  trusted_device_expiry: "${SECURITY_TRUSTED_DEVICE_EXPIRY:30d}"

  # Rate limiting
  rate_limit:
    enabled: ${RATE_LIMIT_ENABLED:true}
    requests_per_minute: ${RATE_LIMIT_REQUESTS_PER_MINUTE:100}
    burst_limit: ${RATE_LIMIT_BURST_LIMIT:20}
    cleanup_interval: "${RATE_LIMIT_CLEANUP_INTERVAL:5m}"

  # Security headers
  security_headers:
    enabled: ${SECURITY_HEADERS_ENABLED:true}
    hsts: ${SECURITY_HEADERS_HSTS:true}
    content_type_options: ${SECURITY_HEADERS_CONTENT_TYPE_OPTIONS:true}
    frame_options: "${SECURITY_HEADERS_FRAME_OPTIONS:DENY}"
    xss_protection: ${SECURITY_HEADERS_XSS_PROTECTION:true}
    referrer_policy: "${SECURITY_HEADERS_REFERRER_POLICY:strict-origin-when-cross-origin}"

  # IP restrictions
  allowed_ips: ${SECURITY_ALLOWED_IPS:[]}
  blocked_countries: ${SECURITY_BLOCKED_COUNTRIES:[]}
  allow_private_networks: ${SECURITY_ALLOW_PRIVATE_NETWORKS:false}

  # Audit and monitoring
  audit:
    enabled: ${SECURITY_AUDIT_ENABLED:true}
    log_all_auth_events: ${SECURITY_AUDIT_LOG_ALL_AUTH_EVENTS:true}
    log_admin_actions: ${SECURITY_AUDIT_LOG_ADMIN_ACTIONS:true}
    retention_days: ${SECURITY_AUDIT_RETENTION_DAYS:2555}
    suspicious_activity_threshold: ${SECURITY_AUDIT_SUSPICIOUS_ACTIVITY_THRESHOLD:5}

  # TLS/SSL settings
  tls:
    enabled: ${SECURITY_TLS_ENABLED:true}
    min_version: "${SECURITY_TLS_MIN_VERSION:1.2}"
    cipher_suites: "${SECURITY_TLS_CIPHER_SUITES:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384}"
    session_timeout: "${SECURITY_TLS_SESSION_TIMEOUT:24h}"
    session_cache_size: ${SECURITY_TLS_SESSION_CACHE_SIZE:1000}

  # Content Security Policy
  csp:
    enabled: ${SECURITY_CSP_ENABLED:true}
    policy: "${SECURITY_CSP_POLICY:default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'}"

  # API security
  api_security:
    require_api_key: ${SECURITY_API_REQUIRE_API_KEY:false}
    validate_content_type: ${SECURITY_API_VALIDATE_CONTENT_TYPE:true}
    max_request_size: "${SECURITY_API_MAX_REQUEST_SIZE:16MB}"
    allowed_content_types: ${SECURITY_API_ALLOWED_CONTENT_TYPES:["application/json", "application/x-www-form-urlencoded"]}

  # Database security
  db_security:
    encrypt_sensitive_data: ${SECURITY_DB_ENCRYPT_SENSITIVE_DATA:true}
    salt_rounds: ${SECURITY_DB_SALT_ROUNDS:12}
    key_rotation_days: ${SECURITY_DB_KEY_ROTATION_DAYS:90}

cors:
  enabled: ${CORS_ENABLED:true}
  allowed_origins: ${CORS_ALLOWED_ORIGINS:["https://app.yourcompany.com"]}
  allowed_methods: ${CORS_ALLOWED_METHODS:["GET", "POST", "PUT", "DELETE", "OPTIONS"]}
  allowed_headers: ${CORS_ALLOWED_HEADERS:["Content-Type", "Authorization", "X-Requested-With"]}
  allow_credentials: ${CORS_ALLOW_CREDENTIALS:true}

rate_limit:
  enabled: ${RATE_LIMIT_ENABLED:true}
  requests_per_minute: ${RATE_LIMIT_REQUESTS_PER_MINUTE:100}

health_check:
  enabled: ${HEALTH_CHECK_ENABLED:true}
  interval: "${HEALTH_CHECK_INTERVAL:30s}"
  timeout: "${HEALTH_CHECK_TIMEOUT:5s}"

# OpenTelemetry Configuration
telemetry:
  enabled: ${TELEMETRY_ENABLED:true}
  service_name: "${TELEMETRY_SERVICE_NAME:auth-service}"
  service_version: "${TELEMETRY_SERVICE_VERSION:1.0.0}"
  environment: "${TELEMETRY_ENVIRONMENT:production}"
  otlp_endpoint: "${TELEMETRY_OTLP_ENDPOINT:localhost:4318}"
  jaeger_endpoint: "${TELEMETRY_JAEGER_ENDPOINT:http://localhost:14268/api/traces}"
  prometheus_port: "${TELEMETRY_PROMETHEUS_PORT:8888}"

# PingAM Configuration (Optional - only if using PingAM mode)
pingam:
  base_url: "${PINGAM_BASE_URL}"
  client_id: "${PINGAM_CLIENT_ID}"
  client_secret: "${PINGAM_CLIENT_SECRET}"
  redirect_uri: "${PINGAM_REDIRECT_URI}"
  scopes: ${PINGAM_SCOPES:["openid", "profile", "email", "groups"]}
  timeout: "${PINGAM_TIMEOUT:30s}"
  retry_attempts: ${PINGAM_RETRY_ATTEMPTS:3}
  cache_ttl: "${PINGAM_CACHE_TTL:5m}"
  enable_sso: ${PINGAM_ENABLE_SSO:true}
  enable_mfa: ${PINGAM_ENABLE_MFA:true}
  enable_risk_based: ${PINGAM_ENABLE_RISK_BASED:true}

  saml:
    entity_id: "${PINGAM_SAML_ENTITY_ID:auth-service}"
    sso_url: "${PINGAM_SAML_SSO_URL:https://pingam.yourcompany.com/saml/sso}"
    slo_url: "${PINGAM_SAML_SLO_URL:https://pingam.yourcompany.com/saml/slo}"
    certificate: "${PINGAM_SAML_CERTIFICATE:/etc/ssl/pingam/cert.pem}"
    private_key: "${PINGAM_SAML_PRIVATE_KEY:/etc/ssl/pingam/key.pem}"
    enabled: ${PINGAM_SAML_ENABLED:true}

  oauth:
    authorization_url: "${PINGAM_OAUTH_AUTHORIZATION_URL:https://pingam.yourcompany.com/oauth/authorize}"
    token_url: "${PINGAM_OAUTH_TOKEN_URL:https://pingam.yourcompany.com/oauth/token}"
    userinfo_url: "${PINGAM_OAUTH_USERINFO_URL:https://pingam.yourcompany.com/oauth/userinfo}"
    scopes: ${PINGAM_OAUTH_SCOPES:["openid", "profile", "email", "groups"]}
    enabled: ${PINGAM_OAUTH_ENABLED:true}

  policy:
    policy_url: "${PINGAM_POLICY_URL:https://pingam.yourcompany.com/policy}"
    decision_url: "${PINGAM_POLICY_DECISION_URL:https://pingam.yourcompany.com/authorize}"
    enable_rbac: ${PINGAM_POLICY_ENABLE_RBAC:true}
    enabled: ${PINGAM_POLICY_ENABLED:true}
  sensitive_fields: ${PINGAM_SENSITIVE_FIELDS:["password", "secret", "token"]}
  alert_thresholds:
    failed_login: ${PINGAM_ALERT_FAILED_LOGIN:5}
    suspicious_activity: ${PINGAM_ALERT_SUSPICIOUS_ACTIVITY:3}

# Authorization Configuration
authorization:
  mode: "${AUTHORIZATION_MODE:jwt}"  # jwt or pingam
  enabled: ${AUTHORIZATION_ENABLED:true}

  jwt_auth:
    use_roles: ${JWT_AUTH_USE_ROLES:true}
    use_permissions: ${JWT_AUTH_USE_PERMISSIONS:true}
    roles_claim_key: "${JWT_AUTH_ROLES_CLAIM_KEY:roles}"
    permissions_claim_key: "${JWT_AUTH_PERMISSIONS_CLAIM_KEY:permissions}"

  pingam_auth:
    enabled: ${PINGAM_AUTH_ENABLED:false}
    cache_ttl: "${PINGAM_AUTH_CACHE_TTL:5m}"
    fallback_to_jwt: ${PINGAM_AUTH_FALLBACK_TO_JWT:false}

