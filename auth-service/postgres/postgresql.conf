# Production PostgreSQL Configuration for Auth Service
# Optimized for high concurrency and performance

# Memory Configuration
shared_buffers = 1GB                    # 25% of total RAM (assuming 4GB server)
effective_cache_size = 3GB              # 75% of total RAM
work_mem = 16MB                         # For complex sorts and joins
maintenance_work_mem = 256MB            # For maintenance operations
shared_preload_libraries = 'pg_stat_statements'

# Connection Configuration
max_connections = 200                   # Increased for production
max_prepared_transactions = 200
max_locks_per_transaction = 128

# WAL Configuration (Write-Ahead Logging)
wal_buffers = 16MB
checkpoint_segments = 32
checkpoint_completion_target = 0.9
wal_level = replica
max_wal_senders = 3
hot_standby = on

# Query Planning
random_page_cost = 1.1                  # SSD optimization
effective_io_concurrency = 200          # SSD optimization

# Logging Configuration
log_destination = 'stderr'
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# Log what we want
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000      # Log queries slower than 1 second
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 0

# Autovacuum Configuration
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 20s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.02
autovacuum_analyze_scale_factor = 0.01

# Background Writer
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# Statement Statistics (for monitoring)
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# Query Optimization
default_statistics_target = 100
constraint_exclusion = on

# Performance Tuning
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# Parallel Query (PostgreSQL 9.6+)
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
parallel_tuple_cost = 0.1
parallel_setup_cost = 1000.0

# Connection Pooling Settings (for pgbouncer)
listen_addresses = '*'
port = 5432
unix_socket_directories = '/var/run/postgresql'

# Security Settings
ssl = on
ssl_cert_file = '/etc/ssl/certs/server.crt'
ssl_key_file = '/etc/ssl/private/server.key'
ssl_ca_file = '/etc/ssl/certs/ca.crt'

# Resource Management
max_files_per_process = 1000
shared_preload_libraries = 'pg_stat_statements,pg_buffercache'

# Deadlock Detection
deadlock_timeout = 1s
max_standby_archive_delay = 30s
max_standby_streaming_delay = 30s

# Replication (if using read replicas)
wal_keep_segments = 32
max_replication_slots = 5

# Statement Timeout (prevent runaway queries)
statement_timeout = 0                   # No timeout by default, but can be set per session

# Lock Timeout
lock_timeout = 0                        # No timeout by default

# Idle Connection Timeout
idle_in_transaction_session_timeout = 0 # No timeout by default

# Connection Settings for High Concurrency
tcp_keepalives_idle = 600              # 10 minutes
tcp_keepalives_interval = 60           # 1 minute
tcp_keepalives_count = 3

# Buffer Pool Settings
temp_buffers = 16MB
max_prepared_transactions = 100

# Cost-based Vacuum Delay
vacuum_cost_delay = 0
vacuum_cost_page_hit = 1
vacuum_cost_page_miss = 10
vacuum_cost_page_dirty = 20
vacuum_cost_limit = 200

# Archive Settings (if needed)
# archive_mode = on
# archive_command = 'cp %p /archive/%f'

# Include custom settings
include_if_exists = '/etc/postgresql/custom.conf'
