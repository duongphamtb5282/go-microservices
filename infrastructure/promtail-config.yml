server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Collect logs from auth-service application (JSON structured)
  - job_name: auth-service-app
    static_configs:
      - targets:
          - localhost
        labels:
          job: auth-service
          service: auth-service
          component: application
          __path__: /tmp/auth-service-logs/auth-service.log
    pipeline_stages:
      - match:
          selector: '{job="auth-service"}'
          stages:
            # Try to parse as JSON first
            - json:
                expressions:
                  level: level
                  timestamp: timestamp
                  message: msg
                  service: service
                  request_id: request_id
            - labels:
                level:
                service:
                request_id:
            # If JSON parsing fails, treat as plain text
            - template:
                source: message
                template: '{{ .Value }}'
            - output:
                source: message
      - timestamp:
          source: timestamp
          format: "2006-01-02T15:04:05Z07:00"
          fallback_formats:
            - "2006-01-02 15:04:05"
            - "Jan 2, 2006 at 3:04pm"

  # Collect logs from Docker containers using simpler approach
  - job_name: docker-containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker-containers
          service: docker
          __path__: /var/log/docker/containers/*/*.log
    pipeline_stages:
      - docker:
          # This will parse Docker JSON log format
      - json:
          expressions:
            log: log
            stream: stream
            time: time
      - labels:
          stream:
      - timestamp:
          source: time
          format: "2006-01-02T15:04:05.000000000Z"
      - output:
          source: log
      - template:
          source: log
          template: '{{ .Value }}'
      - output:
          source: log

  # Collect system logs (syslog format)
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          service: system
          __path__: /var/log/syslog
      - targets:
          - localhost
        labels:
          job: system
          service: system
          __path__: /var/log/messages
    pipeline_stages:
      - match:
          selector: '{job="system"}'
          stages:
            - regex:
                expression: '(?P<timestamp>\w{3} \d{1,2} \d{2}:\d{2}:\d{2}) (?P<hostname>\w+) (?P<program>\w+)(\[(?P<pid>\d+)\])?: (?P<message>.+)'
            - labels:
                hostname:
                program:
                pid:
            - timestamp:
                source: timestamp
                format: "Jan 2 15:04:05"
                location: "UTC"
      - output:
          source: message

  # Collect auth-service specific error logs
  - job_name: auth-service-errors
    static_configs:
      - targets:
          - localhost
        labels:
          job: auth-service-errors
          service: auth-service
          level: error
          __path__: /tmp/auth-service-logs/auth-service.log
    pipeline_stages:
      - match:
          selector: '{level="error"}'
          stages:
            - regex:
                expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}[A-Z]+\d{2}:\d{2})'
            - labels:
                parsed_timestamp: timestamp
            - timestamp:
                source: parsed_timestamp
                format: "2006-01-02T15:04:05Z07:00"
      - output:
          source: message

  # Collect application stdout/stderr logs (fallback)
  - job_name: application-stdout
    static_configs:
      - targets:
          - localhost
        labels:
          job: application
          service: generic
          stream: stdout
          __path__: /var/log/auth-service.log
      - targets:
          - localhost
        labels:
          job: application
          service: generic
          stream: stderr
          __path__: /var/log/auth-service.log
    pipeline_stages:
      - match:
          selector: '{stream="stdout"}'
          stages:
            - regex:
                expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}[A-Z]+\d{2}:\d{2}) \[(?P<level>\w+)\] (?P<message>.+)'
            - labels:
                level:
      - match:
          selector: '{stream="stderr"}'
          stages:
            - regex:
                expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}[A-Z]+\d{2}:\d{2}) \[(?P<level>\w+)\] (?P<message>.+)'
            - labels:
                level:
      - timestamp:
          source: timestamp
          format: "2006-01-02T15:04:05Z07:00"
          fallback_formats:
            - "2006-01-02 15:04:05"
      - output:
          source: message
